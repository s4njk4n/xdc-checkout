<!DOCTYPE html>
<html>
<head><title>Deploy Checkout Contract</title></head>
<body>
  <h2>Deploy Your XDC Checkout Contract</h2>
  <button onclick="deploy()">Deploy Now (via MetaMask)</button>
  <p id="result"></p>

  <script>
    const XDC_NETWORK = {
      chainId: '0x32',
      chainName: 'XDC Network',
      nativeCurrency: { name: 'XDC', symbol: 'XDC', decimals: 18 },
      rpcUrls: ['https://rpc.xinfin.network'],
      blockExplorerUrls: ['https://xdcscan.io']
    };

    async function getReceipt(ethereum, txHash) {
      return new Promise((resolve, reject) => {
        const interval = setInterval(async () => {
          try {
            const receipt = await ethereum.request({
              method: "eth_getTransactionReceipt",
              params: [txHash]
            });
            if (receipt) {
              clearInterval(interval);
              resolve(receipt);
            }
          } catch (err) {
            clearInterval(interval);
            reject(err);
          }
        }, 2000); // Poll every 2 seconds
      });
    }

    async function deploy() {
      const resultEl = document.getElementById("result");
      if (!window.ethereum) return alert("MetaMask not detected! Install from https://metamask.io");

      resultEl.innerHTML = "Connecting...";

      try {
        // Connect wallet
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });

        // Check & switch network
        const chainId = await window.ethereum.request({ method: "eth_chainId" });
        if (chainId !== XDC_NETWORK.chainId) {
          try {
            await window.ethereum.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: XDC_NETWORK.chainId }]
            });
          } catch (switchError) {
            if (switchError.code === 4902) {
              await window.ethereum.request({
                method: "wallet_addEthereumChain",
                params: [XDC_NETWORK]
              });
            } else {
              throw switchError;
            }
          }
        }

        // Bytecode (unchanged)
        const bytecode = "0x60a060405234801561001057600080fd5b503360805260805161035361003d6000396000818160750152818161013c01526101a201526103536000f3fe6080604052600436106100345760003560e01c80632b66d72e146100395780633ccfd60b1461004e5780638da5cb5b14610063575b600080fd5b61004c610047366004610203565b6100b3565b005b34801561005a57600080fd5b5061004c610131565b34801561006f57600080fd5b506100977f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b03909116815260200160405180910390f35b600034116100f35760405162461bcd60e51b815260206004820152600860248201526753656e642058444360c01b60448201526064015b60405180910390fd5b7f0e1824ec6ad5705609823b02e09f5cb8ee98599c78a1e606557ba02c5b776958348233604051610126939291906102b4565b60405180910390a150565b336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146101955760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b60448201526064016100ea565b6040516001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016904780156108fc02916000818181858888f193505050501580156101ea573d6000803e3d6000fd5b50565b634e487b7160e01b600052604160045260246000fd5b60006020828403121561021557600080fd5b813567ffffffffffffffff8082111561022d57600080fd5b818401915084601f83011261024157600080fd5b813581811115610253576102536101ed565b604051601f8201601f19908116603f0116810190838211818310171561027b5761027b6101ed565b8160405282815287602084870101111561029457600080fd5b826020860160208301376000928101602001929092525095945050505050565b83815260006020606081840152845180606085015260005b818110156102e8578681018301518582016080015282016102cc565b5060008482016080908101919091526001600160a01b03959095166040850152601f01601f191690920190920194935050505056fea26469706673582212202465cef057a3c2e839e7d4c3e5f778072c710897d456a730870f61fd1dda38e664736f6c63430008140033";

        resultEl.innerHTML = "Deploying... Please wait.";

        const txHash = await window.ethereum.request({
          method: "eth_sendTransaction",
          params: [{ from: accounts[0], data: bytecode }]
        });

        resultEl.innerHTML = "Transaction sent. Waiting for confirmation...";

        const receipt = await getReceipt(window.ethereum, txHash);

        if (receipt.contractAddress) {
          resultEl.innerHTML = `
            Deployed! Contract: <a href="https://xdcscan.io/address/${receipt.contractAddress}" target="_blank">
              ${receipt.contractAddress}
            </a>
          `;
        } else {
          resultEl.innerHTML = "Deployment failed: No contract address in receipt.";
        }
      } catch (err) {
        resultEl.innerHTML = "";
        alert("Deploy failed: " + (err.message || "Unknown error"));
      }
    }
  </script>
</body>
</html>
